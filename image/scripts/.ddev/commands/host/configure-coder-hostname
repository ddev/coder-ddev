#!/bin/bash

## Description: Configure DDEV hostname for Coder.com router integration
## Usage: configure-coder-hostname
## Example: "ddev configure-coder-hostname"
## Flags: []
## CanRunGlobally: false

# This command configures DDEV to work with Coder's router by generating
# .ddev/config.coder.yaml with the proper hostname and TLD settings.
#
# When running in a Coder workspace, this automatically detects the workspace
# details and creates a config file that matches Coder's URL pattern:
# https://ddev-web--{workspace}--{owner}--{id}.{domain}/
#
# It can be run manually or automatically via a pre-start hook.

# Ensure we're in a DDEV project directory
if [ ! -f .ddev/config.yaml ]; then
    echo "Error: Not in a DDEV project directory"
    echo "Please run this command from your DDEV project root"
    exit 1
fi

# Extract Coder environment variables
WORKSPACE_NAME="${CODER_WORKSPACE_NAME:-}"
WORKSPACE_OWNER="${CODER_WORKSPACE_OWNER_NAME:-}"

# Extract workspace ID and domain from CODER_AGENT_URL
# URL format: https://{workspace-id}.{domain}/
# Example: https://955tu8k2ih1ck.pit-1.try.coder.app/
WORKSPACE_ID=""
CODER_DOMAIN=""

if [ -n "${CODER_AGENT_URL:-}" ]; then
    # Extract workspace ID (subdomain) and domain
    # Remove protocol and trailing slash
    URL_HOST=$(echo "$CODER_AGENT_URL" | sed -E 's|https?://([^/]+).*|\1|')

    # Workspace ID is the first part (before first dot)
    WORKSPACE_ID=$(echo "$URL_HOST" | cut -d'.' -f1)

    # Domain is everything after the first dot
    CODER_DOMAIN=$(echo "$URL_HOST" | cut -d'.' -f2-)
fi

# Check if we're running in Coder with all required info
if [ -z "$WORKSPACE_NAME" ] || [ -z "$WORKSPACE_OWNER" ] || [ -z "$WORKSPACE_ID" ] || [ -z "$CODER_DOMAIN" ]; then
    echo "Not running in Coder environment or missing required information"
    echo "This command only works inside a Coder workspace"
    echo ""
    echo "Missing:"
    [ -z "$WORKSPACE_NAME" ] && echo "  - CODER_WORKSPACE_NAME"
    [ -z "$WORKSPACE_OWNER" ] && echo "  - CODER_WORKSPACE_OWNER_NAME"
    [ -z "$WORKSPACE_ID" ] && echo "  - Workspace ID (from CODER_AGENT_URL)"
    [ -z "$CODER_DOMAIN" ] && echo "  - Coder domain (from CODER_AGENT_URL)"
    [ -z "${CODER_AGENT_URL:-}" ] && echo "  - CODER_AGENT_URL not set"
    exit 1
fi

# Construct DDEV project name to match Coder's app URL pattern
# Pattern: {app-slug}--{workspace}--{owner}--{id}
DDEV_PROJECT_NAME="ddev-web--${WORKSPACE_NAME}--${WORKSPACE_OWNER}--${WORKSPACE_ID}"
PROJECT_TLD="$CODER_DOMAIN"

echo "Configuring DDEV for Coder router..."
echo "  Project Name: $DDEV_PROJECT_NAME"
echo "  Project TLD:  $PROJECT_TLD"

# Create or update .ddev/config.coder.yaml
cat > .ddev/config.coder.yaml <<EOF
# DDEV configuration for Coder.com deployment
# Auto-generated by: ddev configure-coder-hostname
#
# This file configures DDEV to use the hostname that matches Coder's
# router URL pattern. Keep this file out of version control.
#
# To regenerate: ddev configure-coder-hostname

name: ${DDEV_PROJECT_NAME}
project_tld: ${PROJECT_TLD}
EOF

echo "âœ“ Created .ddev/config.coder.yaml"
echo ""
echo "Next steps:"
echo "  1. Restart DDEV: ddev restart"
echo "  2. Access your site at:"
echo "     https://${DDEV_PROJECT_NAME}.${PROJECT_TLD}/"
echo ""
echo "Tip: Add this to .gitignore:"
echo "  echo '.ddev/config.coder.yaml' >> .gitignore"